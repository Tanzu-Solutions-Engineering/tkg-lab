# Install TKG Management Cluster

Follow the [official docs](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-install-cli.html) for background and pre-requisite tasks, which includes downloading tanzu cli and kubectl cli from my.vmware.com and links for docker setup.  Although not required, it is helpful to have the [kind](https://github.com/kubernetes-sigs/kind) cli installed.

Then follow the next section that applies for your environment: AWS, Azure or vSphere. These instructions are based on the official documented steps that use the CLI. Alternatively you can use the Installer Interface and have the management cluster's cluster config file autogenerated with correct and well formatted values.

## Initial Install of Management Cluster

### On AWS

For General Requirements and expected AWS account resource usage, review [Deploy Management Clusters to Amazon EC2](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-mgmt-clusters-aws.html).

It is expected that you already have the `aws` cli and that you've gone through the `aws configure` process to establish local credential auth on your workstation.

1. Once this is complete, we need to:

- [Create an SSH Public Key with your Account](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-mgmt-clusters-aws.html#register-an-ec2-key-pair-11)
- [Required Permissions for the AWS Account](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-mgmt-clusters-aws.html#required-permissions-for-the-aws-account-4)                   

In order to do the steps above in a scripted manner, you simply need to ensure you have populated your `params.yaml` file.  At that point, you can use the following script.  The private key will be stored in the `keys` directory.

```bash
./scripts/01-prep-aws-objects.sh
```

2. The documentation to [Deploy Management Clusters from a Configuration File](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-mgmt-clusters-deploy-cli.html) explains that the `tanzu management-cluster create` cli command requires a configuration file that identifies the configuration values for your management cluster.  While sane defaults have been chosen, make sure Tanzu supported machine types are selected to match those available in the region selected.  The Tanzu UI displays the canonical list of supported machine types.  The script below will copy a template configuration file for AWS from this lab, and then replace the values with the specific configuration found in your `$PARAMS_YAML` file. Run this script to complete the deployment.

```bash
./scripts/02-deploy-aws-mgmt-cluster.sh
```

### On Azure

1. Complete [the initial general requirements](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-mgmt-clusters-azure.html#general-requirements-1) for deploying a TKG management cluster to Azure.

2. Review the [documentation to register a TKG application](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-mgmt-clusters-azure.html#register-tanzu-kubernetes-grid-as-an-azure-client-app-3) on Azure to understand the steps. It's not necessary to manually create the Azure application, instead the below script will automate the steps. It will use the current `az` CLI context to find your tenant and subscription ID, then it will create an application and a client secret. Those items will be written to the parameters file for use in the following steps.

*NOTE: For the `app-name` you can either set it manually in the params file (`azure.app-name`) to a preferred name, or let the script set one.*

```bash
./scripts/01-prep-azure-objects.sh
```

3. Configure additional variables in `params.yaml` in the `azure` section. You will need to set:

* `azure.location` - e.g. canadacentral
* `azure.control-plane-machine-type` - e.g. Standard_D2s_v3 cpu: 2, ram: 8GiB
* `azure.node-machine-type` - e.g. Standard_D2s_v3

4. [Accept the TKG Azure base image license](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-mgmt-clusters-azure.html#accept-the-base-image-license-4).

```bash
az vm image terms accept --publisher vmware-inc --offer tkg-capi --plan k8s-1dot22dot1-ubuntu-2004
```

5. Deploy the management cluster.

```bash
./scripts/02-deploy-azure-mgmt-cluster.sh
```

### On vSphere

1. Complete [Deploy Management Clusters to vSphere](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-mgmt-clusters-vsphere.html) which prepares an SSH key and the OS image templates to be used for all clusters.

First thing you need to do is to download the VMware Tanzu Kubernetes Grid 1.4.0 OVAs for Kubernetes from https://www.vmware.com/go/get-tkg. You need to download v1.21.2 for the management cluster and optionally the others if you choose to deploy workload clusters with a different version of Kubernetes:

- Photon v3 Kubernetes v1.21.2 OVA (our scripts will only use this version)
- Photon v3 Kubernetes v1.20.8 OVA
- Photon v3 Kubernetes v1.19.12 OVA

Then you can follow the manual steps in the documentation or use the following script to automate the creation of the SSH key, upload OVAs and set as template. SSH keys will be stored at `keys/<environment-name>-ssh` and `keys/<environment-name>-ssh.pub`.

You'll need to install [govc](https://github.com/vmware/govmomi/tree/master/govc#installation). You'll also need to fill the `vsphere` configuration block of the `params.yaml` file with the values from your vSphere environment and local folders. Then run this script:

```bash
./scripts/01-prep-vsphere-objects.sh
```

2. Enable AVI integration in TKG and leverage AVI (NSX-ALB) L4 Load Balancing capabilities.

Make sure you install and set up the AVI Controller by following this [instructions](../avi/setup_avi_ctrl.md).

Configure all AVI properties in your `params.yaml` file. For these properties you can leave the default values if you followed the provided AVI Controller Setup instructions.
- `avi-cloud-name: Default-Cloud`
- `avi-service-engine-group: Default-Group`
- `avi-username: admin`
For the CA data use the base64 encoded cert you obtained during the AVI Controller Setup.
- `avi-ca-data: encodedlongstring`
Configure the network information according to your network topology choice and the configuration you added in the Controller. Examples:
- `avi-controller: 192.168.14.190`
- `avi-data-network: VIP-VLAN15-PG`
- `avi-data-network-cidr: 192.168.15.0/24`
- `avi-management-cluster-vip-network: VIP-VLAN15-PG`
- `avi-management-cluster-vip-network-cidr: 192.168.15.0/24`
Set also the control-plane endpoint within the avi-management-cluster-vip-network-cidr:
- `controlplane-endpoint: 192.168.15.20`
Set the admin password
- `avi-password: "REDACTED"`
You can leave labels empty to ensure AVI is used from every cluster
- `avi-labels: ""`


3. The documentation to [Deploy Management Clusters from a Configuration File](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.4/vmware-tanzu-kubernetes-grid-14/GUID-mgmt-clusters-deploy-cli.html) explains that the `tanzu management-cluster create` cli command requires a configuration file that identifies the configuration values for your management cluster.  The script below will copy a template configuration file for vSphere from this lab, and then replace the values with the specific configuration found in your `$PARAMS_YAML` file. Run this script to complete the deployment.

```bash
./scripts/02-deploy-vsphere-mgmt-cluster.sh
```

## Post Deployment Configuration

Deploying management clusters in various IaaS takes anywhere from 10-25 minutes. You have an opportunity here to skip ahead to [Step 3: Configure DNS and Prep Certificate Signing](03_dns_certs_mgmt.md) and [Step 4: Configure Okta](04_okta_mgmt.md) to complete steps in parallel.  Then you can come back and finish off this step.

1. At this point the management cluster is deployed.  We will be adding a few additional components such that we would benefit from two worker nodes in the cluster. The following script will perform these actions.

```bash
./scripts/03-post-deploy-mgmt-cluster.sh
```

2. Validation Step. Check management cluster is provisioned, pods are running:

```bash
tanzu cluster list --include-management-cluster
kubectl get pods -A
```

## Go to Next Step

[Attach Management Cluster to TMC](02_attach_tmc_mgmt.md)
